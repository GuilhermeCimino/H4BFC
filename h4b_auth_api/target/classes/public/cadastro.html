<script>

// PROTE√á√ÉO POR TOKEN - CADASTRO ADM
document.addEventListener('DOMContentLoaded', function() {
    console.log('Verificando autentica√ß√£o...');
    
    // PEGA TOKEN
    const token = localStorage.getItem('h4bfc_token');
    
    // SE N√ÉO TIVER TOKEN = REDIRECIONA
    if (!token) {
        console.error('Token n√£o encontrado!');
        alert('ACESSO RESTRITO!\n\nFa√ßa login como administrador primeiro.');
        window.location.href = 'login.html';
        return;
    }
    
    console.log('Token encontrado');
    
    // VERIFICA TOKEN NA API (/perfil)
    fetch('/perfil', {
        method: 'GET',
        headers: {
            'Authorization': token
        }
    })
    .then(response => {
        if (response.ok) {
            console.log('Token v√°lido! Acesso administrativo permitido.');
            // Mostra que √© ADM
            const h2 = document.querySelector('h2');
            if (h2) {
                h2.innerHTML = 'Cadastrar Novo Funcion√°rio <span style="color: green; font-size: 14px;">(Acesso Administrativo)</span>';
            }
        } else {
            throw new Error('Token inv√°lido');
        }
    })
    .catch(error => {
        console.error('Token inv√°lido:', error);
        localStorage.removeItem('h4bfc_token');
        alert('Sess√£o expirada! Fa√ßa login novamente.');
        window.location.href = 'login.html';
    });
    
    // ADICIONA BOT√ÉO DE SAIR
    const container = document.querySelector('.h4b-login-container');
    if (container) {
        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = 'üö™ Sair';
        logoutBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        `;
        logoutBtn.onclick = function() {
            if (confirm('Sair do modo administrativo?')) {
                localStorage.removeItem('h4bfc_token');
                window.location.href = 'login.html';
            }
        };
        container.style.position = 'relative';
        container.appendChild(logoutBtn);
    }
});


// FORMUL√ÅRIO COM TOKEN
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('cadastroForm');
    
    if (form) {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('h4bfc_token');
            if (!token) {
                alert('Sess√£o expirada!');
                window.location.href = 'login.html';
                return;
            }
            
            // Pega dados
            const nome = document.getElementById('h4b-nome').value;
            const email = document.getElementById('h4b-email').value;
            
            if (!nome || !email) {
                alert('Preencha todos os campos!');
                return;
            }
            
            // Mostra processando
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : 'Cadastrar';
            if (submitBtn) {
                submitBtn.textContent = 'Processando...';
                submitBtn.disabled = true;
            }
            
            try {
                // ENVIA PARA API COM TOKEN
                console.log('Enviando para /api/cadastro...');
                
                const response = await fetch('/api/cadastro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        nome: nome,
                        email: email
                    })
                });
                
                console.log('Resposta:', response.status);
                
                if (response.ok) {
                    const resultado = await response.json();
                    alert('‚úÖ ' + resultado.message);
                    
                    // Mostra mensagem no div
                    const messageDiv = document.getElementById('statusMessage');
                    if (messageDiv) {
                        messageDiv.textContent = '‚úÖ ' + resultado.message;
                        messageDiv.style.display = 'block';
                        messageDiv.style.backgroundColor = '#d4edda';
                        messageDiv.style.color = '#155724';
                    }
                    
                    // Limpa formul√°rio
                    form.reset();
                    
                } else {
                    const erro = await response.text();
                    alert('Erro: ' + erro);
                }
                
            } catch (error) {
                console.error('Erro:', error);
                alert('üîå Erro de conex√£o!');
                
            } finally {
                // Restaura bot√£o
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        });
    }
});
</script>